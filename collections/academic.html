<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Thu Nhiên Gallery
    </title>
    <link rel="icon" href="../assets/gallery icon 32x32.png">

    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Browsing 31 photos in Hàn lâm">
    <meta property="og:title" content="Hàn lâm Collection">
    <meta property="og:description"
        content="Browsing 31 photos in Hàn lâm">
    <meta property="og:image"
        content="https://thunhien.edu.vn/gallery/assets/gallery icon 100x100.png">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:image:width" content="300">
    <meta property="og:type" content="website">
    <meta property="og:url"
        content="https://thunhien.edu.vn/gallery/">
    <!-- <meta property="fb:app_id" content="YOUR_APP_ID"> -->

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../assets/vendor/bootstrap.min.css">
    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --accent-color: #0d6efd;
            --text-primary: #e0e0e0;
        }

        /* body selector removed to fix Light Mode */
        /* Navbar */
        .navbar {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .navbar-brand img {
            height: 40px;
        }

        /* Lightbox - Advanced Split Layout */
        #lightbox-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #lightbox-modal.active {
            display: flex;
            opacity: 1;
        }

        .lightbox-container {
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Left: Stage */
        .lightbox-stage {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            /* Clean black stage */
            overflow: hidden;
        }

        .lightbox-close-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 2rem;
            z-index: 30;
            cursor: pointer;
        }

        /* Sidebar */
        /* Sidebar (Overlay Mode) */
        .lightbox-sidebar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 33vw;
            /* 1/3 Screen */
            min-width: 320px;
            max-width: 90vw;
            /* Mobile safe */

            background: rgba(30, 30, 30, 0.5);
            /* Semi-transparent */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);

            color: #fff;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);

            z-index: 2001;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
        }

        .lightbox-sidebar.hidden {
            transform: translateX(100%);
            /* Slide out to right */
        }

        @media (max-width: 768px) {
            .lightbox-sidebar {
                width: 85vw;
                max-width: none;
            }
        }

        /* Stage Toggle Button (Visible when sidebar hidden) */
        .stage-toggle-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 20;
            transition: all 0.2s;
            opacity: 0;
            /* Hidden by default if sidebar is open */
            pointer-events: none;
        }

        .stage-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            border-color: #fff;
        }

        /* Show toggle button when sidebar is hidden */
        .lightbox-container.sidebar-closed .stage-toggle-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* Toolbar */
        .sidebar-toolbar {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #333;
            background: #252525;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            color: #fff;
            background: #333;
        }

        .icon-btn.close-btn:hover {
            color: #f44;
        }

        /* Content */
        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        #lightbox-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .tags-container {
            margin-bottom: 15px;
        }

        .tag-chip {
            display: inline-block;
            background: #333;
            color: #ccc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            text-decoration: none;
            cursor: pointer;
        }

        .tag-chip:hover {
            background: #0d6efd;
            color: #fff;
        }

        .description-text {
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Footer / Zoom */
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #333;
            background: #252525;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zoom-controls button {
            background: #333;
            border: none;
            color: #fff;
            padding: 5px 10px;
            margin-right: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .zoom-controls button:hover {
            background: #555;
        }

        .counter-text {
            font-size: 0.8rem;
            color: #777;
        }

        /* Navigation Overlays */
        .nav-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 15%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            color: rgba(255, 255, 255, 0.7);
            font-size: 3rem;
        }

        .nav-overlay:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.1);
        }

        .nav-left {
            left: 0;
        }

        .nav-right {
            right: 0;
        }

        /* Mobile Tweaks */
        @media (max-width: 768px) {
            .lightbox-container {
                flex-direction: column;
            }

            .lightbox-sidebar {
                width: 100%;
                max-width: none;
                height: 100% !important;
                /* Full screen height */
                top: 0;
                bottom: 0;
                margin-right: 0 !important;

                /* Transform for Slide Up/Down */
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
                /* Visible state */

                /* Darker background for full screen overlay */
                background: rgba(10, 10, 10, 0.95);
                z-index: 2002;
                /* Above everything */
            }

            .lightbox-sidebar.hidden {
                transform: translateY(100%);
                /* Slide down out of view */
                margin-bottom: 0;
                /* Reset previous logic */
            }

            .lightbox-stage {
                flex: 1;
                width: 100%;
                height: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="../index.html">
            <img src="../assets/gallery icon 100x100.png" alt="Thu Nhiên Gallery" height="40"
                class="d-inline-block align-text-top">
            Thu Nhiên Gallery
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="../404.html">
                        4Fun
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../collections/ai_technology">
                        AI Technology
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../collections/ai-photography">
                        Nhiếp Ảnh AI
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../categories">
                        Danh Mục
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../photos.html">
                        Hình Ảnh
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../albums.html">
                        Albums
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../tags.html">
                        Thẻ
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

        <main>
            <div class="container-fluid">
    <script>
        // Global Context for Variant Page
        window.CURRENT_VARIANT = "academic";
        // Base64 Decode to avoid EJS escaping issues
        try {
            window.currentPhotos = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob("W3siZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wMS5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDEiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDEud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTAxLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wMS5qcGciLCJpZCI6IjY3NzJiNjQ1MDI0Yzc2MGEiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wMi5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDIiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDIud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTAyLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wMi5qcGciLCJpZCI6IjZjZmU5ZjAyNzdjODJiODIiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wMy5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDMiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDMud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTAzLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wMy5qcGciLCJpZCI6ImZkNzY3OTM2YTc1NTFhNjMiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wNC5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDQiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDQud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTA0LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wNC5qcGciLCJpZCI6IjdiMTI1MGZkYTBiNTFjNmUiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wNS5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDUiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDUud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTA1LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wNS5qcGciLCJpZCI6ImIxZjkzYzQ0MDY1YWQ5NTAiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wNi5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDYiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDYud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTA2LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wNi5qcGciLCJpZCI6ImE5MjA2MmYwZGZiMDEzNWYiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI2LWtpZXUtbmd1b2ktYmktbG9haS0wNy5qcGciLCJuYW1lIjoiNi1raWV1LW5ndW9pLWJpLWxvYWktMDciLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjYta2lldS1uZ3VvaS1iaS1sb2FpLTAxIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzYta2lldS1uZ3VvaS1zZS1iaS1sb2FpLWtob2ktY3VvYy1jaG9pLXR1LTIwMjYvNi1raWV1LW5ndW9pLWJpLWxvYWktMDcud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC82LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2LzYta2lldS1uZ3VvaS1iaS1sb2FpLTA3LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNi1raWV1LW5ndW9pLXNlLWJpLWxvYWkta2hvaS1jdW9jLWNob2ktdHUtMjAyNi82LWtpZXUtbmd1b2ktYmktbG9haS0wNy5qcGciLCJpZCI6IjY1YTQwMzY0YmIxMTJmMmIiLCJhbGJ1bVNsdWciOiI2LWtpZXUtbmd1b2ktc2UtYmktbG9haS1raG9pLWN1b2MtY2hvaS10dS0yMDI2IiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDEuanBnIiwibmFtZSI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wMSIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wMS53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wMS53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzLzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wMS5qcGciLCJpZCI6Ijk0ZGNmOWIzN2RjYzU2MjIiLCJhbGJ1bVNsdWciOiI3LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbiIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTAyLmpwZyIsIm5hbWUiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDIiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDIud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDIud2VicCIsInRodW1iIjoidGh1bWJuYWlscy83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDIuanBnIiwiaWQiOiI1ZDYzNjE5OTEzNDA0MGQxIiwiYWxidW1TbHVnIjoiNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4iLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wMy5qcGciLCJuYW1lIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTAzIiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTAzLndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTAzLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTAzLmpwZyIsImlkIjoiZjRjYWFhNGYxYjljMGE0NyIsImFsYnVtU2x1ZyI6IjctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDQuanBnIiwibmFtZSI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNCIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNC53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNC53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzLzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNC5qcGciLCJpZCI6IjcyMTkwODFmYWQwMDcwZWIiLCJhbGJ1bVNsdWciOiI3LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbiIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTA1LmpwZyIsIm5hbWUiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDUiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDUud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDUud2VicCIsInRodW1iIjoidGh1bWJuYWlscy83LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbi83LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDUuanBnIiwiaWQiOiIyYWFjYmMxMjFjYmUwZmRkIiwiYWxidW1TbHVnIjoiNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4iLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNi5qcGciLCJuYW1lIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTA2IiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTA2LndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTA2LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvNy1oYW5oLXZpLXR1LXBoYS1odXktaGluaC1hbmgtY2h1eWVuLW5naGllcC1jdWEtYmFuLXRoYW4vNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuLTA2LmpwZyIsImlkIjoiYjg0ZDM2NTg1YWRkMzYxMSIsImFsYnVtU2x1ZyI6IjctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiI3LWhhbmgtdmktdHUtcGhhLWhvYWktYmFuLXRoYW4tMDcuanBnIiwibmFtZSI6IjctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNyIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiNy1oYW5oLXZpLXR1LXBoYS1ob2FpLWJhbi10aGFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNy53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0LzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNy53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzLzctaGFuaC12aS10dS1waGEtaHV5LWhpbmgtYW5oLWNodXllbi1uZ2hpZXAtY3VhLWJhbi10aGFuLzctaGFuaC12aS10dS1waGEtaG9haS1iYW4tdGhhbi0wNy5qcGciLCJpZCI6IjNiYzNjYzhiMmYxMDMwODAiLCJhbGJ1bVNsdWciOiI3LWhhbmgtdmktdHUtcGhhLWh1eS1oaW5oLWFuaC1jaHV5ZW4tbmdoaWVwLWN1YS1iYW4tdGhhbiIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMDEuanBnIiwibmFtZSI6InRhbS1xdWFuLTAxIiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wMS53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTAxLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDEuanBnIiwiaWQiOiI0MTUwNmM4YTE4ZjcyNDE5IiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTAyLmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0wMiIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDIud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wMi53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTAyLmpwZyIsImlkIjoiOGI2NWU5ODM1ZDExN2YwZCIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiJ0YW0tcXVhbi0wMy5qcGciLCJuYW1lIjoidGFtLXF1YW4tMDMiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IlRhbS1xdWFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTAzLndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDMud2VicCIsInRodW1iIjoidGh1bWJuYWlscy90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wMy5qcGciLCJpZCI6IjMzZDI4MGQzYjU1NTY5NTMiLCJhbGJ1bVNsdWciOiJ0YW0tcXVhbi1jaGluaC10ZSIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMDQuanBnIiwibmFtZSI6InRhbS1xdWFuLTA0IiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wNC53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTA0LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDQuanBnIiwiaWQiOiI2MGRlOTE1ODkxNDUzNmUxIiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTA1LmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0wNSIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDUud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wNS53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTA1LmpwZyIsImlkIjoiYmZkNGM1YmYwNTRjNzVhYSIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiJ0YW0tcXVhbi0wNy5qcGciLCJuYW1lIjoidGFtLXF1YW4tMDciLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IlRhbS1xdWFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTA3LndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDcud2VicCIsInRodW1iIjoidGh1bWJuYWlscy90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wNy5qcGciLCJpZCI6IjViNjExYTBmNDEzZTNkM2YiLCJhbGJ1bVNsdWciOiJ0YW0tcXVhbi1jaGluaC10ZSIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMDguanBnIiwibmFtZSI6InRhbS1xdWFuLTA4IiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wOC53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTA4LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDguanBnIiwiaWQiOiJjZjcwMTc4MGQxZTRiNjI1IiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTA5LmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0wOSIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMDkud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0wOS53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTA5LmpwZyIsImlkIjoiN2I0MzUyZjE3OWFjNDgwMiIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiJ0YW0tcXVhbi0xMC5qcGciLCJuYW1lIjoidGFtLXF1YW4tMTAiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IlRhbS1xdWFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTEwLndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTAud2VicCIsInRodW1iIjoidGh1bWJuYWlscy90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xMC5qcGciLCJpZCI6IjhhYmU2NDhiYzE1YjQwYzciLCJhbGJ1bVNsdWciOiJ0YW0tcXVhbi1jaGluaC10ZSIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMTEuanBnIiwibmFtZSI6InRhbS1xdWFuLTExIiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xMS53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTExLndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTEuanBnIiwiaWQiOiIyM2M5ZmYxY2I3MjM0MzcyIiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTEzLmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0xMyIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTMud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xMy53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTEzLmpwZyIsImlkIjoiOWYxNmViMWU1YTU4YzAyMSIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiJ0YW0tcXVhbi0xNC5qcGciLCJuYW1lIjoidGFtLXF1YW4tMTQiLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IlRhbS1xdWFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE0LndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTQud2VicCIsInRodW1iIjoidGh1bWJuYWlscy90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xNC5qcGciLCJpZCI6Ijc5OGRmZTI4NzdlM2Q2N2QiLCJhbGJ1bVNsdWciOiJ0YW0tcXVhbi1jaGluaC10ZSIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMTUuanBnIiwibmFtZSI6InRhbS1xdWFuLTE1IiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xNS53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE1LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTUuanBnIiwiaWQiOiJjM2VkMDgzYzRjY2U3ZjRjIiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTE2LmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0xNiIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTYud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xNi53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE2LmpwZyIsImlkIjoiM2IyM2RiYmVmZGI2NTE4MSIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9LHsiZmlsZW5hbWUiOiJ0YW0tcXVhbi0xNy5qcGciLCJuYW1lIjoidGFtLXF1YW4tMTciLCJtZXRhZGF0YSI6eyJ0YWdzIjpbIm5ow6JuIl0sInZhcmlhbnQiOiJhY2FkZW1pYyIsImF0dHJpYnV0ZXMiOnsiZmllbGQiOiJuaMOibiJ9fSwiY29udGVudCI6IiIsInNvdXJjZUZvbGRlciI6IlRhbS1xdWFuIiwidHlwZSI6InNpbmdsZSIsInNyYyI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE3LndlYnAiLCJzcmNfc2luZ2xlIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTcud2VicCIsInRodW1iIjoidGh1bWJuYWlscy90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xNy5qcGciLCJpZCI6IjczZmQ0NDEwMDcwMzVmNmUiLCJhbGJ1bVNsdWciOiJ0YW0tcXVhbi1jaGluaC10ZSIsImZvcm1hdCI6IndlYnAifSx7ImZpbGVuYW1lIjoidGFtLXF1YW4tMTguanBnIiwibmFtZSI6InRhbS1xdWFuLTE4IiwibWV0YWRhdGEiOnsidGFncyI6WyJuaMOibiJdLCJ2YXJpYW50IjoiYWNhZGVtaWMiLCJhdHRyaWJ1dGVzIjp7ImZpZWxkIjoibmjDom4ifX0sImNvbnRlbnQiOiIiLCJzb3VyY2VGb2xkZXIiOiJUYW0tcXVhbiIsInR5cGUiOiJzaW5nbGUiLCJzcmMiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xOC53ZWJwIiwic3JjX3NpbmdsZSI6InNwbGl0L3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE4LndlYnAiLCJ0aHVtYiI6InRodW1ibmFpbHMvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTguanBnIiwiaWQiOiJiZjRmZGNjOGRiMTAzNjVkIiwiYWxidW1TbHVnIjoidGFtLXF1YW4tY2hpbmgtdGUiLCJmb3JtYXQiOiJ3ZWJwIn0seyJmaWxlbmFtZSI6InRhbS1xdWFuLTE5LmpwZyIsIm5hbWUiOiJ0YW0tcXVhbi0xOSIsIm1ldGFkYXRhIjp7InRhZ3MiOlsibmjDom4iXSwidmFyaWFudCI6ImFjYWRlbWljIiwiYXR0cmlidXRlcyI6eyJmaWVsZCI6Im5ow6JuIn19LCJjb250ZW50IjoiIiwic291cmNlRm9sZGVyIjoiVGFtLXF1YW4iLCJ0eXBlIjoic2luZ2xlIiwic3JjIjoic3BsaXQvdGFtLXF1YW4tY2hpbmgtdGUvdGFtLXF1YW4tMTkud2VicCIsInNyY19zaW5nbGUiOiJzcGxpdC90YW0tcXVhbi1jaGluaC10ZS90YW0tcXVhbi0xOS53ZWJwIiwidGh1bWIiOiJ0aHVtYm5haWxzL3RhbS1xdWFuLWNoaW5oLXRlL3RhbS1xdWFuLTE5LmpwZyIsImlkIjoiYjAwZmIzNjEzNDYyMTQyMyIsImFsYnVtU2x1ZyI6InRhbS1xdWFuLWNoaW5oLXRlIiwiZm9ybWF0Ijoid2VicCJ9XQ=="), c => c.charCodeAt(0))));
        } catch (e) {
            console.error("Failed to parse variant photos:", e);
            window.currentPhotos = [];
        }
        // Pre-fix paths immediately
        (function () {
            const root = "..";
            if (window.currentPhotos) {
                window.currentPhotos.forEach(p => {
                    if (p.src && !p.src.startsWith('http')) {
                        p.src = root + '/' + (p.src_single || p.src || p.thumb);
                        if (p.src_a) p.src_a = root + '/' + p.src_a;
                        if (p.src_b) p.src_b = root + '/' + p.src_b;
                    }
                });
            }
        })();
    </script>
    <div class="row">

        <!-- Sidebar Filter (Offcanvas on Mobile, Sticky on Desktop) -->
        <div class="col-lg-3 col-xl-2 d-none d-lg-block border-end bg-light min-vh-100 py-4" id="desktop-sidebar">
            <div class="offcanvas-body">
    <h5 class="mb-3">
        Bộ Lọc
    </h5>

    <!-- Use class instead of ID to allow multiple instances (Desktop/Mobile) -->
    <div class="variant-filter-container">
        <!-- Filters will be loaded here via JS -->
        <div class="text-center text-muted small">Loading filters...</div>
    </div>
</div>

<script>
    // Use a named function to avoid re-declaring variables if script is included twice
    // Or just wrap in IIFE
    (function () {
        // Guard to prevent double execution if this specific script block runs twice
        // Actually, we WANT it to run for each container, or run once for ALL containers.
        // Since this script is output twice, let's just make it idempotent or targeted.

        // Safer: Logic to populate ALL .variant-filter-container elements.
        // But we only want to fetch once.

        if (window.hasInitFilterScript) return;
        window.hasInitFilterScript = true;

        document.addEventListener('DOMContentLoaded', async () => {
            const root = "..";
            // Check if we are on a specific variant page
            const currentVariant = window.CURRENT_VARIANT;
            const containers = document.querySelectorAll('.variant-filter-container');

            try {
                const res = await fetch(root + '/data/facets.json');
                if (!res.ok) return;
                const facets = await res.json();

                // Find data for this variant
                const variantData = facets.find(f => f.variant === currentVariant);

                // Prepare HTML content
                let contentHtml = '';

                if (!variantData || !variantData.filters) {
                    contentHtml = `
                        <div class="alert alert-warning small">
                            <strong>Debug Info:</strong><br>
                            Current: "<b>${currentVariant}</b>"<br>
                            Available: ${facets.map(f => f.variant).join(', ')}<br>
                            Match Found: ${!!variantData}
                        </div>
                    `;
                } else {
                    variantData.filters.forEach(filter => {
                        contentHtml += `
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2 text-uppercase text-muted small">${filter.label}</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${filter.values.map(val => `
                                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadFilteredPhotos('${val.filename}')">
                                            ${val.value} (${val.count})
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }

                // Inject into ALL containers (Desktop & Mobile)
                containers.forEach(c => c.innerHTML = contentHtml);

            } catch (e) {
                console.error("Facet Load Error:", e);
                containers.forEach(c => c.innerHTML = '<p class="text-danger small">Error loading filters</p>');
            }
        });

        // Global function for filter click
        window.loadFilteredPhotos = async function (filename) {
            const root = "..";
            try {
                // Show loading state on Grid
                const grid = document.getElementById('masonry-grid');
                if (grid) grid.style.opacity = '0.5';

                const res = await fetch(root + '/data/facets/' + filename);
                if (!res.ok) throw new Error("Load failed");
                const photos = await res.json();

                // Re-render Grid
                // Note: We need to match the structure in variant.ejs
                const html = photos.map((photo, index) => {
                    // We need to recalculate src for the grid display
                    const thumb = root + '/' + (photo.thumb || photo.src);

                    // NOTE: We need a way to open lightbox with correct data.
                    // The photos array changes. Pushing new photos to window.currentPhotos?
                    // Or replacing?

                    // Design choice: Replace window.currentPhotos with filtered set.
                    // So index 0 is first filtered photo.

                    return `
                        <div class="col-6 col-md-4 col-xl-3 grid-item">
                             <div class="card h-100 shadow-sm border-0 portfolio-card">
                                <a href="javascript:void(0)" onclick="openLightbox(${index})" class="text-decoration-none text-dark">
                                    <div class="card-img-wrapper bg-light overflow-hidden position-relative">
                                        <img src="${thumb}"
                                             class="w-100"
                                             alt="${photo.name}"
                                             loading="lazy">
                                        <div class="view-overlay position-absolute bottom-0 start-0 p-2 text-white text-shadow small" data-view-id="${photo.id}">
                                             <ion-icon name="eye"></ion-icon> <span class="view-count-text">...</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');

                if (grid) {
                    grid.innerHTML = html;
                    // Destory old masonry? Masonry handles appending well, but replacement needs care.
                    // Simplest: Re-init.

                    // Update Global Photos
                    window.currentPhotos = photos.map(p => ({
                        ...p,
                        src: root + '/' + (p.src_single || p.src || p.thumb),
                        src_a: p.src_a ? root + '/' + p.src_a : null,
                        src_b: p.src_b ? root + '/' + p.src_b : null
                    })); // Replace context

                    imagesLoaded(grid, function () {
                        // Check if masonry instance exists?
                        // Masonry.data(grid).destroy(); // Optional
                        new Masonry(grid, { itemSelector: '.grid-item', percentPosition: true });
                        grid.style.opacity = '1';

                        if (window.refreshViewCounts) window.refreshViewCounts();
                    });
                }

            } catch (e) {
                console.error(e);
                alert("Error loading filter");
                const grid = document.getElementById('masonry-grid');
                if (grid) grid.style.opacity = '1';
            }
        };
    })();
</script>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-xl-10 py-4">

            <!-- Mobile Toggle -->
            <button class="btn btn-outline-dark d-lg-none mb-3" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#filterOffcanvas">
                <ion-icon name="filter"></ion-icon>
                Bộ Lọc
            </button>

            <!-- Hero -->
            <div class="d-flex align-items-center mb-4 border-bottom pb-3">
                <div>
                    <h1 class="display-5 mb-0">
                        Hàn lâm Collection
                    </h1>
                    <p class="text-muted">
                        31 photos
                    </p>
                </div>
            </div>

            <!-- Grid -->
            <div class="row g-2" id="masonry-grid" data-masonry='{"percentPosition": true }'>
                <!-- Photos injected via JS -->
            </div>

            <!-- Loading Sentinel -->
            <div id="sentinel" class="py-5 text-center text-muted">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Offcanvas Filter -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Filters</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="offcanvas-body">
    <h5 class="mb-3">
        Bộ Lọc
    </h5>

    <!-- Use class instead of ID to allow multiple instances (Desktop/Mobile) -->
    <div class="variant-filter-container">
        <!-- Filters will be loaded here via JS -->
        <div class="text-center text-muted small">Loading filters...</div>
    </div>
</div>

<script>
    // Use a named function to avoid re-declaring variables if script is included twice
    // Or just wrap in IIFE
    (function () {
        // Guard to prevent double execution if this specific script block runs twice
        // Actually, we WANT it to run for each container, or run once for ALL containers.
        // Since this script is output twice, let's just make it idempotent or targeted.

        // Safer: Logic to populate ALL .variant-filter-container elements.
        // But we only want to fetch once.

        if (window.hasInitFilterScript) return;
        window.hasInitFilterScript = true;

        document.addEventListener('DOMContentLoaded', async () => {
            const root = "..";
            // Check if we are on a specific variant page
            const currentVariant = window.CURRENT_VARIANT;
            const containers = document.querySelectorAll('.variant-filter-container');

            try {
                const res = await fetch(root + '/data/facets.json');
                if (!res.ok) return;
                const facets = await res.json();

                // Find data for this variant
                const variantData = facets.find(f => f.variant === currentVariant);

                // Prepare HTML content
                let contentHtml = '';

                if (!variantData || !variantData.filters) {
                    contentHtml = `
                        <div class="alert alert-warning small">
                            <strong>Debug Info:</strong><br>
                            Current: "<b>${currentVariant}</b>"<br>
                            Available: ${facets.map(f => f.variant).join(', ')}<br>
                            Match Found: ${!!variantData}
                        </div>
                    `;
                } else {
                    variantData.filters.forEach(filter => {
                        contentHtml += `
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2 text-uppercase text-muted small">${filter.label}</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${filter.values.map(val => `
                                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadFilteredPhotos('${val.filename}')">
                                            ${val.value} (${val.count})
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }

                // Inject into ALL containers (Desktop & Mobile)
                containers.forEach(c => c.innerHTML = contentHtml);

            } catch (e) {
                console.error("Facet Load Error:", e);
                containers.forEach(c => c.innerHTML = '<p class="text-danger small">Error loading filters</p>');
            }
        });

        // Global function for filter click
        window.loadFilteredPhotos = async function (filename) {
            const root = "..";
            try {
                // Show loading state on Grid
                const grid = document.getElementById('masonry-grid');
                if (grid) grid.style.opacity = '0.5';

                const res = await fetch(root + '/data/facets/' + filename);
                if (!res.ok) throw new Error("Load failed");
                const photos = await res.json();

                // Re-render Grid
                // Note: We need to match the structure in variant.ejs
                const html = photos.map((photo, index) => {
                    // We need to recalculate src for the grid display
                    const thumb = root + '/' + (photo.thumb || photo.src);

                    // NOTE: We need a way to open lightbox with correct data.
                    // The photos array changes. Pushing new photos to window.currentPhotos?
                    // Or replacing?

                    // Design choice: Replace window.currentPhotos with filtered set.
                    // So index 0 is first filtered photo.

                    return `
                        <div class="col-6 col-md-4 col-xl-3 grid-item">
                             <div class="card h-100 shadow-sm border-0 portfolio-card">
                                <a href="javascript:void(0)" onclick="openLightbox(${index})" class="text-decoration-none text-dark">
                                    <div class="card-img-wrapper bg-light overflow-hidden position-relative">
                                        <img src="${thumb}"
                                             class="w-100"
                                             alt="${photo.name}"
                                             loading="lazy">
                                        <div class="view-overlay position-absolute bottom-0 start-0 p-2 text-white text-shadow small" data-view-id="${photo.id}">
                                             <ion-icon name="eye"></ion-icon> <span class="view-count-text">...</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');

                if (grid) {
                    grid.innerHTML = html;
                    // Destory old masonry? Masonry handles appending well, but replacement needs care.
                    // Simplest: Re-init.

                    // Update Global Photos
                    window.currentPhotos = photos.map(p => ({
                        ...p,
                        src: root + '/' + (p.src_single || p.src || p.thumb),
                        src_a: p.src_a ? root + '/' + p.src_a : null,
                        src_b: p.src_b ? root + '/' + p.src_b : null
                    })); // Replace context

                    imagesLoaded(grid, function () {
                        // Check if masonry instance exists?
                        // Masonry.data(grid).destroy(); // Optional
                        new Masonry(grid, { itemSelector: '.grid-item', percentPosition: true });
                        grid.style.opacity = '1';

                        if (window.refreshViewCounts) window.refreshViewCounts();
                    });
                }

            } catch (e) {
                console.error(e);
                alert("Error loading filter");
                const grid = document.getElementById('masonry-grid');
                if (grid) grid.style.opacity = '1';
            }
        };
    })();
</script>
    </div>
</div>


<!-- Core Vendors -->
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/vendor/bootstrap.bundle.min.js"></script>
<script src="../assets/vendor/imagesloaded.pkgd.min.js"></script>
<script src="../assets/vendor/masonry.pkgd.min.js"></script>

<!-- Utils -->
<script src="../assets/vendor/crypto-js.min.js"></script>
<script src="../assets/vendor/panzoom.min.js"></script>

<!-- App Init -->
<script src="../assets/js/firebase-init-config.js"></script>

<!-- View Counting & Global Logic -->
<script>
    // Global View Counting Logic
    window.updateViewCounts = function () {
        document.querySelectorAll('[data-view-id]').forEach(el => {
            const id = el.getAttribute('data-view-id');
            // Mock or Real Firebase Logic
            // If firebase is init in layout, we hook here.
            // For now, placeholder or check sessionStorage
            // Real implementation would connect to Firebase refs here.

            // Note: layout.ejs usually handles the "Active" page logic.
            // But for Grid items, we might need a centralized observer.
        });
    }
</script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State
            const CHUNK_SIZE = 48; // Multiple of 2, 3, 4 for grid alignment
            let renderedCount = 0;
            let grid = document.querySelector('#masonry-grid');
            let sentinel = document.getElementById('sentinel');
            let masonryInstance = null;

            // Initialize Masonry immediately
            if (grid) {
                masonryInstance = new Masonry(grid, {
                    itemSelector: '.grid-item',
                    percentPosition: true
                });
            }

            // Render Function
            window.renderNextChunk = function () {
                const photos = window.currentPhotos || [];
                if (renderedCount >= photos.length) {
                    sentinel.innerText = "End of Collection";
                    return;
                }

                const nextBatch = photos.slice(renderedCount, renderedCount + CHUNK_SIZE);
                const root = "..";

                const html = nextBatch.map((photo, i) => {
                    const index = renderedCount + i;
                    return `
                        <div class="col-6 col-md-4 col-xl-3 grid-item">
                            <div class="card h-100 shadow-sm border-0 portfolio-card">
                                <a href="javascript:void(0)" onclick="openLightbox(${index})"
                                    class="text-decoration-none text-dark">
                                        <div class="card-img-wrapper bg-light overflow-hidden position-relative">
                                            <img src="${root}/${photo.thumb || photo.src}"
                                                class="w-100"
                                                alt="${photo.name}" loading="lazy">
                                        <div class="view-overlay position-absolute bottom-0 start-0 p-2 text-white text-shadow small" data-view-id="${photo.id}">
                                            <ion-icon name="eye"></ion-icon> <span class="view-count-text">...</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>`;
                }).join('');

                // Append
                // Create elements (jQuery way usually safer for Masonry, but Vanilla works if we parse)
                // Vanilla append
                grid.insertAdjacentHTML('beforeend', html);

                // Get newly added elements
                // Simplest: Just reloadItems and layout for now. 
                // Better: appended() method needs DOM elements. 
                // Let's do a simple reload + imagesLoaded for robustness.

                imagesLoaded(grid, function () {
                    masonryInstance.reloadItems();
                    masonryInstance.layout();
                    if (window.refreshViewCounts) window.refreshViewCounts();
                });

                renderedCount += nextBatch.length;

                if (renderedCount >= photos.length) {
                    sentinel.style.display = 'none'; // distinct from "End of text"
                }
            };

            // Observer
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    window.renderNextChunk();
                }
            }, { rootMargin: '400px' });

            observer.observe(sentinel);
        });
    </script>
        </main>

        <!-- Custom Lightbox CSS (Pulse/Hint) -->
        <style>
            /* Pulsing Hint Animation */
            @keyframes pulse-ring {
                0% {
                    box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
                }
            }

            .pulse-btn {
                animation: pulse-ring 2s infinite;
                color: #fff !important;
                background: rgba(13, 110, 253, 0.3) !important;
                border-color: #0d6efd !important;
            }

            /* Hint Tooltip */
            .hint-tooltip {
                position: absolute;
                background: #0d6efd;
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.8rem;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
                z-index: 3000;
                white-space: nowrap;
            }

            /* Positioning tooltip for desktop sidebar button */
            .sidebar-toolbar .hint-tooltip {
                top: 100%;
                left: 10px;
                margin-top: 5px;
            }

            /* Positioning tooltip for floating toggle button */
            .stage-toggle-btn .hint-tooltip {
                bottom: 100%;
                right: 0;
                margin-bottom: 10px;
            }

            /* Show tooltip logic class */
            .hint-visible {
                opacity: 1;
            }

            /* Ensure Floating Button is Clickable */
            .stage-toggle-btn {
                position: absolute;
                bottom: 20px;
                right: 20px;
                z-index: 2050;
                /* Higher than image stage (1000) but lower than tooltip */
                background: rgba(0, 0, 0, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .stage-toggle-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            /* Only show when sidebar is hidden (handled by JS logic mostly, or CSS if parent has class) */
            .lightbox-container.sidebar-closed .stage-toggle-btn {
                display: flex;
            }

            /* Start hidden if sidebar is open, if that is the design? */
            /* Actually, the button is inside lightbox-stage. */
        </style>

        <!-- Lightbox Modal (Advanced UI) -->
        <div id="lightbox-modal">
            <!-- Main Container: Flex Row -->
            <div class="lightbox-container">

                <!-- Left: Image Stage -->
                <div class="lightbox-stage">
                    <!-- Close Button (Mobile/Tablet or when sidebar hidden) -->
                    <button class="lightbox-close-btn d-md-none" onclick="closeLightbox()">&times;</button>

                    <div id="lightbox-image-container"></div>

                    <!-- Floating Info Toggle (New) -->
                    <button class="stage-toggle-btn" onclick="toggleSidebar()"
                        title="Hiện Thông Tin (i)">
                        <ion-icon name="information-circle-outline"></ion-icon>
                    </button>

                    <!-- Navigation Overlays -->
                    <div class="nav-overlay nav-left" onclick="prevPhoto()">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </div>
                    <div class="nav-overlay nav-right" onclick="nextPhoto()">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </div>
                </div>

                <!-- Right: Sidebar (Info Panel) -->
                <div id="lightbox-sidebar" class="lightbox-sidebar">
                    <!-- Toolbar -->
                    <div class="sidebar-toolbar">
                        <div class="left-tools d-flex align-items-center gap-2">
                            <div class="position-relative">
                                <button id="sidebar-info-btn" class="icon-btn" onclick="toggleSidebar()"
                                    title="Bật/Tắt Thông Tin (i)">
                                    <ion-icon name="information-circle-outline"></ion-icon>
                                </button>
                                <div id="sidebar-hint" class="hint-tooltip">
                                    Ẩn Thông Tin
                                </div>
                            </div>

                            <!-- Counter (Moved Up) -->
                            <div id="lightbox-counter" class="counter-text fw-bold text-white ms-2">1 / 1</div>

                            <!-- View Count -->
                            <div class="d-flex align-items-center gap-1 ms-3"
                                title="Lượt xem"
                                style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                                <ion-icon name="eye-outline"></ion-icon>
                                <span id="lightbox-view-count-val">...</span>
                            </div>
                        </div>
                        <div class="right-tools">
                            <button class="icon-btn" onclick="copyMeta()"
                                title="Sao chép Metadata (c)">
                                <ion-icon name="copy-outline"></ion-icon>
                            </button>
                            <button class="icon-btn" onclick="sharePhoto()"
                                title="Chia sẻ (s)">
                                <ion-icon name="share-social-outline"></ion-icon>
                            </button>
                            <button class="icon-btn close-btn" onclick="closeLightbox()"
                                title="Đóng (Esc)">
                                <ion-icon name="close-outline"></ion-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="sidebar-content">
                        <h3 id="lightbox-title">
                            Tiêu đề ảnh
                        </h3>

                        <div id="lightbox-desc" class="description-text" style="margin-bottom: 15px;">
                            <!-- Description injected here -->
                        </div>

                        <div id="lightbox-tags" class="tags-container">
                            <!-- Tags injected here -->
                        </div>

                        <div id="lightbox-content" class="description-text"
                            style="white-space: pre-wrap; margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                            <!-- Body content injected here -->
                        </div>
                    </div>

                    <div class="sidebar-footer justify-content-end">
                        <!-- Zoom Controls REMOVED -->
                        <small class="text-muted">
                            Nhấn &#39;F&#39; để đặt lại Zoom
                        </small>
                    </div>
                </div>

            </div>
        </div>

        <footer class="bg-dark text-white text-center py-4 mt-5">
    <div class="container">
        <p class="mb-0">&copy; 2026
                Thu Nhiên Gallery. Được xây dựng bởi AnPH21.</p>
    </div>
</footer>

            <!-- Custom Lightbox Logic -->
            <script>
                // Lightbox Global State
                let hintTimer = null;
                let panzoomInstance = null;
                let currentIndex = 0;

                function openLightbox(index, skipHistory = false) {
                    try {
                        // Safety checks
                        if (!currentPhotos || currentPhotos.length === 0) return;
                        currentIndex = index;
                        const photo = currentPhotos[index];

                        // 1. Deep Link
                        if (!skipHistory) {
                            const safeName = photo.name.replace(/\s+/g, '-').toLowerCase();
                            history.pushState(null, null, `#${safeName}`);
                        }

                        const modal = document.getElementById('lightbox-modal');
                        const container = document.getElementById('lightbox-image-container');
                        const sidebar = document.getElementById('lightbox-sidebar');
                        const mainContainer = document.querySelector('.lightbox-container');

                        if (!modal || !container || !sidebar) throw new Error("Elements missing");

                        // Mobile Optimization: Auto-hide sidebar by default
                        if (window.innerWidth <= 768) {
                            sidebar.classList.add('hidden');
                            mainContainer.classList.add('sidebar-closed');
                        } else {
                            // Desktop: Ensure open by default
                            sidebar.classList.remove('hidden');
                            mainContainer.classList.remove('sidebar-closed');
                        }

                        // 2. Render Sidebar Info
                        document.getElementById('lightbox-title').innerText = photo.metadata?.title || photo.name;
                        document.getElementById('lightbox-counter').innerText = `${currentIndex + 1} / ${currentPhotos.length}`;
                        document.getElementById('lightbox-desc').innerText = photo.metadata?.description || '';
                        document.getElementById('lightbox-content').innerText = photo.content || '';

                        // Render Tags
                        const tagSelect = document.getElementById('lightbox-tags');
                        const rootPath = ".." || ".";
                        tagSelect.innerHTML = (photo.metadata?.tags || []).map(tag =>
                            `<a href="${rootPath}/tag?id=${encodeURIComponent(tag)}" class="tag-chip">${tag}</a>`
                        ).join('');

                        // 3. Render Image Stage
                        if (panzoomInstance) { try { panzoomInstance.dispose(); } catch (e) { } }
                        panzoomInstance = null;
                        container.innerHTML = '';

                        // Split vs Single Logic
                        if ((photo.type === 'split' || (photo.src_a && photo.src_b)) && photo.src_a && photo.src_b) {
                            container.innerHTML = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#000;"><canvas id="stitchCanvas" style="max-width:100%; max-height:100%; cursor: grab; display:block;"></canvas></div>`;
                            const canvas = document.getElementById('stitchCanvas');

                            if (typeof CanvasStitchViewer !== 'undefined') {
                                if (window.canvasViewer) { /* clean */ }
                                window.canvasViewer = new CanvasStitchViewer(canvas, photo.src_a, photo.src_b);
                                panzoomInstance = null;
                                addDecoyOverlay(container, canvas);
                            } else {
                                container.innerHTML = "<p style='color:white'>Error: Viewer component missing.</p>";
                            }
                        } else {
                            if (window.canvasViewer) window.canvasViewer = null;

                            const img = document.createElement('img');
                            img.src = photo.src;
                            img.style.maxHeight = '90vh';
                            img.style.maxWidth = '90vw';
                            img.draggable = false;

                            // Load handler
                            img.onload = () => {
                                initPanzoom(img);
                                addDecoyOverlay(container, img);
                            };

                            container.appendChild(img);
                        }

                        if (typeof window.trackView === 'function') {
                            window.trackView(photo);
                        }

                        // Activate Modal
                        modal.classList.add('active');
                        // Clean up any forced inline styles from previous debug steps
                        modal.style.removeProperty('display');
                        modal.style.removeProperty('opacity');

                        // Reset Hint Timer
                        if (typeof resetHintTimer === 'function') resetHintTimer();

                    } catch (e) {
                        console.error("Lightbox Error:", e);
                    }
                }

                // --- Panzoom Helper ---
                function initPanzoom(elem) {
                    // Clean up previous instance
                    if (panzoomInstance) {
                        try { panzoomInstance.dispose(); } catch (e) { }
                        panzoomInstance = null;
                    }

                    // Initialize new instance
                    try {
                        panzoomInstance = panzoom(elem, {
                            maxZoom: 5,
                            minZoom: 1,
                            bounds: true,
                            boundsPadding: 0.1,
                            zoomDoubleClickSpeed: 1 // Disable zoom on double click if needed, or keep default
                        });
                    } catch (e) {
                        console.error("Panzoom Init Failed:", e);
                    }
                }

                // --- Sidebar & Tools ---
                function toggleSidebar() {
                    const sidebar = document.getElementById('lightbox-sidebar');
                    const container = document.querySelector('.lightbox-container');
                    const isClosed = sidebar.classList.toggle('hidden');
                    container.classList.toggle('sidebar-closed');

                    // Reset Hint Timer on Toggle
                    resetHintTimer();
                }

                // --- UX Hint Logic ---
                function resetHintTimer() {
                    // Clear existing
                    clearTimeout(hintTimer);
                    removePulse();

                    // Set new timer (3 seconds)
                    hintTimer = setTimeout(() => {
                        showPulseHint();
                    }, 3000);
                }

                function showPulseHint() {
                    const sidebar = document.getElementById('lightbox-sidebar');
                    const isHidden = sidebar.classList.contains('hidden');

                    let targetBtn, tooltip, msg;

                    if (isHidden) {
                        // Target the floating button
                        targetBtn = document.querySelector('.stage-toggle-btn');
                        // We need to inject tooltip if not exists or select it
                        // Simplified: Assume we added tooltip html structure dynamically or statically?
                        // Let's add tooltip structure in HTML above for both buttons

                        // For floating button (needs dynamic tooltip insertion since it's simple button)
                        if (!targetBtn.querySelector('.hint-tooltip')) {
                            const tt = document.createElement('div');
                            tt.className = 'hint-tooltip';
                            targetBtn.appendChild(tt);
                        }
                        tooltip = targetBtn.querySelector('.hint-tooltip');
                        msg = "Mở Thông Tin";
                    } else {
                        // Target the sidebar button
                        targetBtn = document.getElementById('sidebar-info-btn');
                        tooltip = document.getElementById('sidebar-hint');
                        msg = "Ẩn Thông Tin";
                    }

                    if (targetBtn && tooltip) {
                        targetBtn.classList.add('pulse-btn');
                        tooltip.innerText = msg;
                        tooltip.classList.add('hint-visible');

                        // Auto hide after 5s or click?
                        // Let's hide on next interaction (click handles it via toggle -> resetHintTimer)
                        // But also auto-hide pulse after 4s to not annoy
                        setTimeout(() => removePulse(), 4000);
                    }
                }

                function removePulse() {
                    document.querySelectorAll('.pulse-btn').forEach(el => el.classList.remove('pulse-btn'));
                    document.querySelectorAll('.hint-visible').forEach(el => el.classList.remove('hint-visible'));
                }

                function copyMeta() {
                    if (!currentPhotos[currentIndex]) return;
                    const p = currentPhotos[currentIndex];
                    // Copy ONLY body content
                    const content = p.content || '';
                    if (content) {
                        navigator.clipboard.writeText(content).catch(err => console.error("Copy failed:", err));
                    }
                }

                // --- Unified Share Helper ---
                window.shareUrl = async function (title, text, url) {
                    if (navigator.share) {
                        try {
                            await navigator.share({ title, text, url });
                        } catch (err) {
                            console.error("Share failed:", err);
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(url);
                            alert('Đã sao chép liên kết!');
                        } catch (err) {
                            console.error("Clipboard failed:", err);
                            prompt("Sao chép liên kết này:", url);
                        }
                    }
                };

                function sharePhoto() {
                    const url = window.location.href;
                    window.shareUrl(document.title, 'Xem ảnh này nhé!', url);
                }

                // --- Zoom Controls (Global) ---
                window.zoomIn = function () {
                    if (window.canvasViewer) window.canvasViewer.zoomIn();
                    else if (panzoomInstance) panzoomInstance.zoomIn();
                };

                window.zoomOut = function () {
                    if (window.canvasViewer) window.canvasViewer.zoomOut();
                    else if (panzoomInstance) panzoomInstance.zoomOut();
                };

                // --- Zoom Controls (Global) ---
                window.zoomIn = function () {
                    if (window.canvasViewer) window.canvasViewer.zoomIn();
                    else if (panzoomInstance) panzoomInstance.zoomIn();
                };

                window.zoomOut = function () {
                    if (window.canvasViewer) window.canvasViewer.zoomOut();
                    else if (panzoomInstance) panzoomInstance.zoomOut();
                };

                // --- Decoy Overlay Helper ---
                function addDecoyOverlay(container, targetElement) {
                    const decoy = document.createElement('img');
                    decoy.src = "../assets/cest-la-vie.png";
                    decoy.style.position = "absolute";
                    decoy.style.top = "0";
                    decoy.style.left = "0";
                    decoy.style.width = "100%";
                    decoy.style.height = "100%";
                    decoy.style.zIndex = "50";
                    decoy.style.opacity = "0.01"; // Invisible but clickable
                    decoy.style.objectFit = "fill"; // Cover full area
                    decoy.style.cursor = "inherit"; // Keep cursor style
                    decoy.alt = "Copyright";

                    // Prevent Dragging the Decoy itself
                    decoy.draggable = false;

                    // Message on Right Click (Optional, or just let them save)
                    // decoy.oncontextmenu = (e) => { /* Default browser menu opens on this image */ };

                    // --- Event Forwarding ---
                    // We must manually forward interaction events to the underlying target
                    // because the overlay blocks them.

                    const forwardEvent = (e) => {
                        // Create a new event based on the original
                        // We can't re-dispatch the exact same event object.
                        // We construct a new one.
                        let newEvent;

                        // FIX: Check WheelEvent FIRST because it inherits from MouseEvent
                        if (e instanceof WheelEvent) {
                            newEvent = new WheelEvent(e.type, {
                                bubbles: true, cancelable: true, view: window,
                                deltaX: e.deltaX, deltaY: e.deltaY, deltaZ: e.deltaZ,
                                deltaMode: e.deltaMode,
                                clientX: e.clientX, clientY: e.clientY // Important for zoom center
                            });
                        } else if (e instanceof MouseEvent) {
                            newEvent = new MouseEvent(e.type, {
                                bubbles: true, cancelable: true, view: window,
                                detail: e.detail, screenX: e.screenX, screenY: e.screenY,
                                clientX: e.clientX, clientY: e.clientY,
                                ctrlKey: e.ctrlKey, altKey: e.altKey, shiftKey: e.shiftKey, metaKey: e.metaKey,
                                button: e.button, buttons: e.buttons, relatedTarget: e.relatedTarget
                            });
                        } else if (typeof TouchEvent !== 'undefined' && e instanceof TouchEvent) {
                            // Touch events are hard to synthesize perfectly due to TouchList.
                            // But Panzoom often attaches to 'touchstart' on the element.
                            // Forwarding Touch is complex. 
                            // Easier strategy for Touch: 
                            // Mobile usually doesn't have "Right Click Save As" easily on overlays?
                            // Actually long press calls context menu.
                            // If we set pointer-events: none on mobile?
                        }

                        if (newEvent && targetElement) {
                            targetElement.dispatchEvent(newEvent);
                        }
                    };

                    // Forward Mouse & Wheel
                    ['mousedown', 'wheel'].forEach(evt => {
                        decoy.addEventListener(evt, (e) => {
                            // Do NOT prevent default here, or context menu (right click) might fail?
                            // Right click is 'contextmenu' event.
                            // mousedown is left/middle/right.
                            if (e.type === 'mousedown' && e.button === 2) {
                                // Right click -> Let browser handle it (Context Menu on Decoy)
                                return;
                            }
                            // Forward others
                            // e.preventDefault(); // Maybe?
                            forwardEvent(e);
                        });
                    });

                    // Touch: Just pass through?
                    // If we set pointer-events: none for touch?
                    // Mobile "Save Image" via Long Press.
                    // If we forward touchstart, we might double trigger?
                    // For now, let's keep touch simple. Most users hold-to-save.
                    // If we want to allow Zoom on mobile, we need touch events to go through.
                    // Let's try setting pointer-events: none ONLY for touch devices? 
                    // No, hybrid devices exist.

                    // Simple hack for Touch: Use pointer-events: none;
                    // Because "Save Image" is less a concern on mobile vs PC right-click.
                    // OR, forward touchstart/move/end.

                    container.appendChild(decoy);
                }

                window.resetZoom = function () {
                    if (window.canvasViewer) window.canvasViewer.reset();
                    else if (panzoomInstance) panzoomInstance.reset();
                };

                // --- Navigation ---
                function closeLightbox(skipHistory = false) {
                    document.getElementById('lightbox-modal').classList.remove('active');
                    if (!skipHistory) {
                        history.pushState(null, null, ' ');
                    }
                    if (panzoomInstance) { try { panzoomInstance.dispose(); } catch (e) { } panzoomInstance = null; }
                }
                function nextPhoto() { if (currentIndex < currentPhotos.length - 1) openLightbox(currentIndex + 1); }
                function prevPhoto() { if (currentIndex > 0) openLightbox(currentIndex - 1); }

                // --- Event Listeners ---
                // --- Event Listeners ---
                document.addEventListener('keydown', (e) => {
                    const modal = document.getElementById('lightbox-modal');
                    if (!modal || !modal.classList.contains('active')) return;

                    switch (e.key.toLowerCase()) {
                        case 'escape': closeLightbox(); break;
                        case 'arrowright': nextPhoto(); break;
                        case 'arrowleft': prevPhoto(); break;
                        case 'i': toggleSidebar(); break;
                        case 'c': copyMeta(); break;
                        case 's': sharePhoto(); break;

                        // Zoom Keys
                        case '+':
                        case '=': // Plus without shift on some layouts
                            zoomIn();
                            break;

                        case '-':
                        case '_': // Minus with shift
                            zoomOut();
                            break;

                        case 'f':
                        case '0': // Ctrl+0 style reset
                            resetZoom();
                            break;
                    }
                });

                // Wheel Navigation (on Stage background only)
                document.addEventListener('wheel', (e) => {
                    const modal = document.getElementById('lightbox-modal');
                    if (!modal || !modal.classList.contains('active')) return;

                    // If target is the stage (black background) or nav overlay, navigate
                    if (e.target.classList.contains('lightbox-stage') || e.target.classList.contains('nav-overlay')) {
                        if (e.deltaY > 0) nextPhoto();
                        else prevPhoto();
                    }
                });

                // --- Global Exports ---
                window.openLightbox = openLightbox;
                window.closeLightbox = closeLightbox;
                window.nextPhoto = nextPhoto;
                window.prevPhoto = prevPhoto;
                window.toggleSidebar = toggleSidebar;
                window.copyMeta = copyMeta;
                window.sharePhoto = sharePhoto;
                // zoom functions are already on window (defined as window.zoomIn, etc.)

                // Deep Link Check on Load
                window.addEventListener('DOMContentLoaded', () => {
                    const hash = window.location.hash.substring(1); // Remove #
                    if (hash && typeof currentPhotos !== 'undefined' && currentPhotos.length > 0) {
                        // Find photo by loosely matching name
                        const idx = currentPhotos.findIndex(p =>
                            p.name.replace(/\s+/g, '-').toLowerCase() === hash.toLowerCase()
                        );
                        if (idx !== -1) {
                            console.log("Deep link found:", hash, "Opening index:", idx);
                            // Wait a bit for masonry/ui to settle? No, just open.
                            openLightbox(idx);
                        }
                    }
                });

                // History Navigation Handler
                window.addEventListener('popstate', (event) => {
                    const hash = window.location.hash.substring(1);
                    if (hash && currentPhotos && currentPhotos.length > 0) {
                        // Find photo by hash
                        const idx = currentPhotos.findIndex(p =>
                            p.name.replace(/\s+/g, '-').toLowerCase() === hash.toLowerCase()
                        );
                        if (idx !== -1) {
                            openLightbox(idx, true); // skipHistory = true
                        }
                    } else {
                        // No hash -> Close lightbox
                        closeLightbox(true); // skipHistory = true
                    }
                });

                console.log("✅ Lightbox functions attached to window.");
            </script>

            <!-- Canvas Viewer (SRCIS) -->
            <script src="../assets/js/canvas-viewer.js"></script>

            <!-- Bootstrap JS (Local) -->
            <script src="../assets/vendor/bootstrap.bundle.min.js"></script>

            <!-- Panzoom (Local) -->
            <script src="../assets/vendor/panzoom.min.js"></script>
            <!-- CryptoJS (Local) -->
            <script src="../assets/vendor/crypto-js.min.js"></script>

            <!-- Firebase SDK -->
            <!-- Firebase Config (Generated) -->
            <script src="../assets/js/firebase-init-config.js"></script>

            <script type="module">
                import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
                import { getDatabase, ref, increment, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

                const firebaseConfig = window.FIREBASE_CONFIG || {};
                // Removed duplicate declaration

                let db = null;

                if (true && firebaseConfig.apiKey) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        db = getDatabase(app);
                        console.log("🔥 Firebase Initialized");

                        // 1. Initial Sync (Get all views once for Grid)
                        syncGlobalViews();

                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                    }
                }

                // --- Global View Functions ---

                // A. Sync all views for Grid Items
                async function syncGlobalViews() {
                    if (!db) return;
                    const viewNodes = document.querySelectorAll('[data-view-id]');
                    if (viewNodes.length === 0) return;

                    // Optimization: Fetch ALL views once (assuming lightweight dataset < 1MB)
                    // If dataset grows > 10k items, we might need batched gets, but for now this is fastest/cheapest.
                    const dbRef = ref(db, 'views');
                    try {
                        const snapshot = await get(dbRef);
                        if (snapshot.exists()) {
                            const allViews = snapshot.val();
                            updateDomCounts(allViews);
                        }

                        // Optional: Listen for changes? 
                        // For cost savings, we usually don't listen to the WHOLE list. 
                        // Just fetching once on load is enough for grid.
                        // Lightbox handles real-time single updates.
                    } catch (e) {
                        console.error("View Sync Error:", e);
                    }
                }

                function updateDomCounts(allViews) {
                    const viewNodes = document.querySelectorAll('[data-view-id]');
                    viewNodes.forEach(node => {
                        const id = node.getAttribute('data-view-id');
                        if (allViews[id]) {
                            const countParams = node.querySelectorAll('.view-count-text');
                            countParams.forEach(el => el.innerText = allViews[id]);
                        } else {
                            const countParams = node.querySelectorAll('.view-count-text');
                            countParams.forEach(el => el.innerText = '0');
                        }
                    });
                }

                // B. Track View (triggered by Lightbox)
                window.trackView = function (photo) {
                    if (!db) { console.error("❌ Firebase DB not initialized."); return; }
                    if (!photo) { console.warn("❌ TrackView called with null photo."); return; }

                    // const viewId = `${photo.albumSlug}__${photo.filename.replace(/\./g, '_')}`; 
                    // Wait, `photo.id` in feed/album JSONs is ALREADY generated correctly.
                    const viewId = photo.id;
                    console.log("👀 Tracking View for:", viewId);

                    if (!viewId) { console.warn("No viewId for photo", photo); return; }

                    // Real-time Listener for Lightbox Sidebar
                    const viewRef = ref(db, `views/${viewId}`);

                    // 1. Listen (Realtime UI Update)
                    // Unsubscribe previous if exists? (Simple way: just new listener, it overwrites context if clean)
                    // Better: Store unsubscribe fn if needed. For now, onValue returns unsubscribe.
                    const unsub = onValue(viewRef, (snapshot) => {
                        const count = snapshot.val() || 0;
                        // Update Lightbox Sidebar
                        const lbCount = document.getElementById('lightbox-view-count-val');
                        if (lbCount) lbCount.innerText = count;
                    });
                    // Store unsub to cleanup on close? (Valid optimization for SPA users)
                    window.currentViewUnsub = unsub;


                    // 2. Increment Transaction (Spam Control: localStorage)
                    const storageKey = `viewed_${viewId}`;
                    const hasViewed = localStorage.getItem(storageKey);

                    if (!hasViewed) {
                        console.log("🚀 Incrementing view count...");
                        update(ref(db), {
                            [`views/${viewId}`]: increment(1)
                        }).then(() => {
                            console.log("✅ View Count Incremented:", viewId);
                            localStorage.setItem(storageKey, 'true');
                        }).catch(e => {
                            console.error("❌ Firebase Update Error:", e);
                            if (e.code === 'PERMISSION_DENIED') console.warn("💡 Check Firebase Rules test mode.");
                        });
                    } else {
                        console.log("Duplicate view ignored (localStorage check).");
                    }
                };

                // Cleanup listener helper
                window.cleanupViewListener = function () {
                    if (window.currentViewUnsub) {
                        window.currentViewUnsub();
                        window.currentViewUnsub = null;
                    }
                }

                // Global Debug Helper
                window.debugFirebase = {
                    checkConnection: () => {
                        if (db) console.log("✅ Firebase DB Instance exists.");
                        else console.error("❌ Firebase DB is NULL.");
                    },
                    forceTrack: (id) => {
                        if (!db) return;
                        update(ref(db), { [`views/${id}`]: increment(1) })
                            .then(() => console.log("Forced update success"))
                            .catch(e => console.error(e));
                    },
                    clearHistory: () => {
                        localStorage.clear();
                        console.log("Cleared localStorage history.");
                    }
                };

                // Expose sync for infinite scrollMasonry to call after append
                window.refreshViewCounts = syncGlobalViews;

            </script>
</body>

</html>